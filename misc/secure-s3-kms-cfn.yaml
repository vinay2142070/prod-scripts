AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Secure S3 bucket with KMS (SSE-KMS) encryption, public access blocked,
  HTTPS-only bucket policy, versioning, and lifecycle rule.

Resources:

  SecureKmsKey:
    Type: AWS::KMS::Key
    Properties:
      Description: "KMS key for S3 bucket encryption (created by CFN)"
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Sid: "Allow account full access to the key"
            Effect: "Allow"
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action: "kms:*"
            Resource: "*"
          - Sid: "Allow S3 to use the key for encryption operations"
            Effect: "Allow"
            Principal:
              Service: "s3.amazonaws.com"
            Action:
              - "kms:Encrypt"
              - "kms:Decrypt"
              - "kms:ReEncrypt*"
              - "kms:GenerateDataKey*"
              - "kms:DescribeKey"
            Resource: "*"
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref "AWS::AccountId"

  SecureBucket:
    Type: AWS::S3::Bucket
    Properties:
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref SecureKmsKey
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        IgnorePublicAcls: true
        BlockPublicPolicy: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: "TransitionToIA"
            Status: Enabled
            Prefix: ""
            Transitions:
              - TransitionInDays: 30
                StorageClass: STANDARD_IA
            ExpirationInDays: 365

  SecureBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref SecureBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: "DenyUnEncryptedTransport"
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource:
              - !Sub "arn:aws:s3:::${SecureBucket}"
              - !Sub "arn:aws:s3:::${SecureBucket}/*"
            Condition:
              Bool:
                aws:SecureTransport: "false"

Outputs:
  BucketName:
    Description: "Name of the secure S3 bucket"
    Value: !Ref SecureBucket

  KmsKeyArn:
    Description: "ARN of the customer-managed KMS key used for SSE-KMS"
    Value: !GetAtt SecureKmsKey.Arn
